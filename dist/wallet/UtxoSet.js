// @ts-ignore
import bitcore from 'bitcore-lib-cash';
import { logger } from '../utils/logger';
export class UtxoSet {
    constructor() {
        this.utxos = {};
        this.inUse = [];
        this.totalBalance = 0;
        this.availableBalance = 0;
        this.utxoStorage = {};
    }
    get length() {
        return Object.keys(this.utxos).length;
    }
    /**
     * Add UTXOs to UTXO set.
     * @param utxos Array of UTXOs from kaspa API.
     * @param address Address of UTXO owner.
     */
    add(utxos, address) {
        const utxoIds = [];
        utxos.forEach((utxo) => {
            const utxoId = utxo.transactionId + utxo.index.toString();
            const utxoInUse = this.inUse.indexOf(utxoId) !== -1;
            const alreadyHaveIt = this.utxos[utxoId];
            if (!utxoInUse && !alreadyHaveIt && utxo.isSpendable) {
                utxoIds.push(utxoId);
                this.utxos[utxoId] = new bitcore.Transaction.UnspentOutput({
                    txid: utxo.transactionId,
                    address,
                    vout: utxo.index,
                    scriptPubKey: utxo.scriptPubKey,
                    satoshis: utxo.value,
                });
            }
        });
        if (utxoIds.length) {
            logger.log('info', `Added ${utxoIds.length} UTXOs to UtxoSet.`);
            // this.updateUtxoBalance();
        }
        return utxoIds;
    }
    remove(utxoIds) {
        this.release(utxoIds);
        utxoIds.forEach((id) => delete this.utxos[id]);
    }
    release(utxoIdsToEnable) {
        // assigns new array without any utxoIdsToEnable
        this.inUse = this.inUse.filter((utxoId) => utxoIdsToEnable.indexOf(utxoId) === -1);
        // this.updateUtxoBalance();
    }
    updateUtxoBalance() {
        const utxoIds = Object.keys(this.utxos);
        const utxoIdsNotInUse = utxoIds.filter((key) => this.inUse.indexOf(key) === -1);
        this.totalBalance = utxoIds.reduce((prev, cur) => prev + this.utxos[cur].satoshis, 0);
        this.availableBalance = utxoIdsNotInUse.reduce((prev, cur) => prev + this.utxos[cur].satoshis, 0);
    }
    clear() {
        this.utxos = {};
        this.inUse = [];
        this.availableBalance = 0;
        logger.log('info', 'UTXO set cleared.');
    }
    /**
     * Naively select UTXOs.
     * @param txAmount Provide the amount that the UTXOs should cover.
     * @throws Error message if the UTXOs can't cover the `txAmount`
     */
    selectUtxos(txAmount) {
        const utxos = [];
        const utxoIds = [];
        let totalVal = 0;
        for (const [utxoId, utxo] of Object.entries(this.utxos)) {
            if (this.inUse.indexOf(utxoId) === -1) {
                utxoIds.push(utxoId);
                utxos.push(utxo);
                totalVal += utxo.satoshis;
            }
            if (totalVal >= txAmount)
                break;
        }
        if (totalVal < txAmount)
            throw new Error(`Transaction compose error. Need: ${txAmount}, UTXO Balance: ${totalVal}`);
        return { utxoIds, utxos };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXR4b1NldC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3dhbGxldC9VdHhvU2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLGFBQWE7QUFDYixPQUFPLE9BQU8sTUFBTSxrQkFBa0IsQ0FBQztBQUN2QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFekMsTUFBTSxPQUFPLE9BQU87SUFBcEI7UUFDRSxVQUFLLEdBQXNELEVBQUUsQ0FBQztRQUU5RCxVQUFLLEdBQWEsRUFBRSxDQUFDO1FBRXJCLGlCQUFZLEdBQUcsQ0FBQyxDQUFDO1FBRWpCLHFCQUFnQixHQUFHLENBQUMsQ0FBQztRQU1yQixnQkFBVyxHQUErQixFQUFFLENBQUM7SUFnRi9DLENBQUM7SUFwRkMsSUFBSSxNQUFNO1FBQ1IsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDeEMsQ0FBQztJQUlEOzs7O09BSUc7SUFDSCxHQUFHLENBQUMsS0FBaUIsRUFBRSxPQUFlO1FBQ3BDLE1BQU0sT0FBTyxHQUFhLEVBQUUsQ0FBQztRQUM3QixLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDckIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQzFELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ3BELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDekMsSUFBSSxDQUFDLFNBQVMsSUFBSSxDQUFDLGFBQWEsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO2dCQUNwRCxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUNyQixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksT0FBTyxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUM7b0JBQ3pELElBQUksRUFBRSxJQUFJLENBQUMsYUFBYTtvQkFDeEIsT0FBTztvQkFDUCxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUs7b0JBQ2hCLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWTtvQkFDL0IsUUFBUSxFQUFFLElBQUksQ0FBQyxLQUFLO2lCQUNyQixDQUFDLENBQUM7YUFDSjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFO1lBQ2xCLE1BQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLFNBQVMsT0FBTyxDQUFDLE1BQU0sb0JBQW9CLENBQUMsQ0FBQztZQUNoRSw0QkFBNEI7U0FDN0I7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBRUQsTUFBTSxDQUFDLE9BQWlCO1FBQ3RCLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdEIsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVELE9BQU8sQ0FBQyxlQUF5QjtRQUMvQixnREFBZ0Q7UUFDaEQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25GLDRCQUE0QjtJQUM5QixDQUFDO0lBRUQsaUJBQWlCO1FBQ2YsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDeEMsTUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNoRixJQUFJLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDdEYsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGVBQWUsQ0FBQyxNQUFNLENBQzVDLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxFQUM5QyxDQUFDLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLO1FBQ0gsSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDaEIsSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDaEIsSUFBSSxDQUFDLGdCQUFnQixHQUFHLENBQUMsQ0FBQztRQUMxQixNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsV0FBVyxDQUFDLFFBQWdCO1FBQzFCLE1BQU0sS0FBSyxHQUF3QyxFQUFFLENBQUM7UUFDdEQsTUFBTSxPQUFPLEdBQWEsRUFBRSxDQUFDO1FBQzdCLElBQUksUUFBUSxHQUFHLENBQUMsQ0FBQztRQUNqQixLQUFLLE1BQU0sQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDdkQsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtnQkFDckMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDckIsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDakIsUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUM7YUFDM0I7WUFDRCxJQUFJLFFBQVEsSUFBSSxRQUFRO2dCQUFFLE1BQU07U0FDakM7UUFDRCxJQUFJLFFBQVEsR0FBRyxRQUFRO1lBQ3JCLE1BQU0sSUFBSSxLQUFLLENBQUMsb0NBQW9DLFFBQVEsbUJBQW1CLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDN0YsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQztJQUM1QixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcGkgfSBmcm9tICdjdXN0b20tdHlwZXMnO1xuLy8gQHRzLWlnbm9yZVxuaW1wb3J0IGJpdGNvcmUgZnJvbSAnYml0Y29yZS1saWItY2FzaCc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuXG5leHBvcnQgY2xhc3MgVXR4b1NldCB7XG4gIHV0eG9zOiBSZWNvcmQ8c3RyaW5nLCBiaXRjb3JlLlRyYW5zYWN0aW9uLlVuc3BlbnRPdXRwdXQ+ID0ge307XG5cbiAgaW5Vc2U6IHN0cmluZ1tdID0gW107XG5cbiAgdG90YWxCYWxhbmNlID0gMDtcblxuICBhdmFpbGFibGVCYWxhbmNlID0gMDtcblxuICBnZXQgbGVuZ3RoKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMudXR4b3MpLmxlbmd0aDtcbiAgfVxuXG4gIHV0eG9TdG9yYWdlOiBSZWNvcmQ8c3RyaW5nLCBBcGkuVXR4b1tdPiA9IHt9O1xuXG4gIC8qKlxuICAgKiBBZGQgVVRYT3MgdG8gVVRYTyBzZXQuXG4gICAqIEBwYXJhbSB1dHhvcyBBcnJheSBvZiBVVFhPcyBmcm9tIGthc3BhIEFQSS5cbiAgICogQHBhcmFtIGFkZHJlc3MgQWRkcmVzcyBvZiBVVFhPIG93bmVyLlxuICAgKi9cbiAgYWRkKHV0eG9zOiBBcGkuVXR4b1tdLCBhZGRyZXNzOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgdXR4b0lkczogc3RyaW5nW10gPSBbXTtcbiAgICB1dHhvcy5mb3JFYWNoKCh1dHhvKSA9PiB7XG4gICAgICBjb25zdCB1dHhvSWQgPSB1dHhvLnRyYW5zYWN0aW9uSWQgKyB1dHhvLmluZGV4LnRvU3RyaW5nKCk7XG4gICAgICBjb25zdCB1dHhvSW5Vc2UgPSB0aGlzLmluVXNlLmluZGV4T2YodXR4b0lkKSAhPT0gLTE7XG4gICAgICBjb25zdCBhbHJlYWR5SGF2ZUl0ID0gdGhpcy51dHhvc1t1dHhvSWRdO1xuICAgICAgaWYgKCF1dHhvSW5Vc2UgJiYgIWFscmVhZHlIYXZlSXQgJiYgdXR4by5pc1NwZW5kYWJsZSkge1xuICAgICAgICB1dHhvSWRzLnB1c2godXR4b0lkKTtcbiAgICAgICAgdGhpcy51dHhvc1t1dHhvSWRdID0gbmV3IGJpdGNvcmUuVHJhbnNhY3Rpb24uVW5zcGVudE91dHB1dCh7XG4gICAgICAgICAgdHhpZDogdXR4by50cmFuc2FjdGlvbklkLFxuICAgICAgICAgIGFkZHJlc3MsXG4gICAgICAgICAgdm91dDogdXR4by5pbmRleCxcbiAgICAgICAgICBzY3JpcHRQdWJLZXk6IHV0eG8uc2NyaXB0UHViS2V5LFxuICAgICAgICAgIHNhdG9zaGlzOiB1dHhvLnZhbHVlLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAodXR4b0lkcy5sZW5ndGgpIHtcbiAgICAgIGxvZ2dlci5sb2coJ2luZm8nLCBgQWRkZWQgJHt1dHhvSWRzLmxlbmd0aH0gVVRYT3MgdG8gVXR4b1NldC5gKTtcbiAgICAgIC8vIHRoaXMudXBkYXRlVXR4b0JhbGFuY2UoKTtcbiAgICB9XG4gICAgcmV0dXJuIHV0eG9JZHM7XG4gIH1cblxuICByZW1vdmUodXR4b0lkczogc3RyaW5nW10pOiB2b2lkIHtcbiAgICB0aGlzLnJlbGVhc2UodXR4b0lkcyk7XG4gICAgdXR4b0lkcy5mb3JFYWNoKChpZCkgPT4gZGVsZXRlIHRoaXMudXR4b3NbaWRdKTtcbiAgfVxuXG4gIHJlbGVhc2UodXR4b0lkc1RvRW5hYmxlOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIC8vIGFzc2lnbnMgbmV3IGFycmF5IHdpdGhvdXQgYW55IHV0eG9JZHNUb0VuYWJsZVxuICAgIHRoaXMuaW5Vc2UgPSB0aGlzLmluVXNlLmZpbHRlcigodXR4b0lkKSA9PiB1dHhvSWRzVG9FbmFibGUuaW5kZXhPZih1dHhvSWQpID09PSAtMSk7XG4gICAgLy8gdGhpcy51cGRhdGVVdHhvQmFsYW5jZSgpO1xuICB9XG5cbiAgdXBkYXRlVXR4b0JhbGFuY2UoKTogdm9pZCB7XG4gICAgY29uc3QgdXR4b0lkcyA9IE9iamVjdC5rZXlzKHRoaXMudXR4b3MpO1xuICAgIGNvbnN0IHV0eG9JZHNOb3RJblVzZSA9IHV0eG9JZHMuZmlsdGVyKChrZXkpID0+IHRoaXMuaW5Vc2UuaW5kZXhPZihrZXkpID09PSAtMSk7XG4gICAgdGhpcy50b3RhbEJhbGFuY2UgPSB1dHhvSWRzLnJlZHVjZSgocHJldiwgY3VyKSA9PiBwcmV2ICsgdGhpcy51dHhvc1tjdXJdLnNhdG9zaGlzLCAwKTtcbiAgICB0aGlzLmF2YWlsYWJsZUJhbGFuY2UgPSB1dHhvSWRzTm90SW5Vc2UucmVkdWNlKFxuICAgICAgKHByZXYsIGN1cikgPT4gcHJldiArIHRoaXMudXR4b3NbY3VyXS5zYXRvc2hpcyxcbiAgICAgIDBcbiAgICApO1xuICB9XG5cbiAgY2xlYXIoKTogdm9pZCB7XG4gICAgdGhpcy51dHhvcyA9IHt9O1xuICAgIHRoaXMuaW5Vc2UgPSBbXTtcbiAgICB0aGlzLmF2YWlsYWJsZUJhbGFuY2UgPSAwO1xuICAgIGxvZ2dlci5sb2coJ2luZm8nLCAnVVRYTyBzZXQgY2xlYXJlZC4nKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBOYWl2ZWx5IHNlbGVjdCBVVFhPcy5cbiAgICogQHBhcmFtIHR4QW1vdW50IFByb3ZpZGUgdGhlIGFtb3VudCB0aGF0IHRoZSBVVFhPcyBzaG91bGQgY292ZXIuXG4gICAqIEB0aHJvd3MgRXJyb3IgbWVzc2FnZSBpZiB0aGUgVVRYT3MgY2FuJ3QgY292ZXIgdGhlIGB0eEFtb3VudGBcbiAgICovXG4gIHNlbGVjdFV0eG9zKHR4QW1vdW50OiBudW1iZXIpOiB7IHV0eG9JZHM6IHN0cmluZ1tdOyB1dHhvczogYml0Y29yZS5UcmFuc2FjdGlvbi5VbnNwZW50T3V0cHV0W10gfSB7XG4gICAgY29uc3QgdXR4b3M6IGJpdGNvcmUuVHJhbnNhY3Rpb24uVW5zcGVudE91dHB1dFtdID0gW107XG4gICAgY29uc3QgdXR4b0lkczogc3RyaW5nW10gPSBbXTtcbiAgICBsZXQgdG90YWxWYWwgPSAwO1xuICAgIGZvciAoY29uc3QgW3V0eG9JZCwgdXR4b10gb2YgT2JqZWN0LmVudHJpZXModGhpcy51dHhvcykpIHtcbiAgICAgIGlmICh0aGlzLmluVXNlLmluZGV4T2YodXR4b0lkKSA9PT0gLTEpIHtcbiAgICAgICAgdXR4b0lkcy5wdXNoKHV0eG9JZCk7XG4gICAgICAgIHV0eG9zLnB1c2godXR4byk7XG4gICAgICAgIHRvdGFsVmFsICs9IHV0eG8uc2F0b3NoaXM7XG4gICAgICB9XG4gICAgICBpZiAodG90YWxWYWwgPj0gdHhBbW91bnQpIGJyZWFrO1xuICAgIH1cbiAgICBpZiAodG90YWxWYWwgPCB0eEFtb3VudClcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVHJhbnNhY3Rpb24gY29tcG9zZSBlcnJvci4gTmVlZDogJHt0eEFtb3VudH0sIFVUWE8gQmFsYW5jZTogJHt0b3RhbFZhbH1gKTtcbiAgICByZXR1cm4geyB1dHhvSWRzLCB1dHhvcyB9O1xuICB9XG59XG4iXX0=