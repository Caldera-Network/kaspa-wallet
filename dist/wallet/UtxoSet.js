"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.UtxoSet = void 0;
// @ts-ignore
const bitcore_lib_cash_1 = require("bitcore-lib-cash");
const logger_1 = require("../utils/logger");
class UtxoSet {
    constructor() {
        this.utxos = {};
        this.inUse = [];
        this.totalBalance = 0;
        this.availableBalance = 0;
        this.utxoStorage = {};
    }
    get length() {
        return Object.keys(this.utxos).length;
    }
    /**
     * Add UTXOs to UTXO set.
     * @param utxos Array of UTXOs from kaspa API.
     * @param address Address of UTXO owner.
     */
    add(utxos, address) {
        const utxoIds = [];
        utxos.forEach((utxo) => {
            const utxoId = utxo.transactionId + utxo.index.toString();
            const utxoInUse = this.inUse.indexOf(utxoId) !== -1;
            const alreadyHaveIt = this.utxos[utxoId];
            if (!utxoInUse && !alreadyHaveIt && utxo.isSpendable) {
                utxoIds.push(utxoId);
                this.utxos[utxoId] = new bitcore_lib_cash_1.default.Transaction.UnspentOutput({
                    txid: utxo.transactionId,
                    address,
                    vout: utxo.index,
                    scriptPubKey: utxo.scriptPubKey,
                    satoshis: utxo.value,
                });
            }
        });
        if (utxoIds.length) {
            logger_1.logger.log('info', `Added ${utxoIds.length} UTXOs to UtxoSet.`);
            // this.updateUtxoBalance();
        }
        return utxoIds;
    }
    remove(utxoIds) {
        this.release(utxoIds);
        utxoIds.forEach((id) => delete this.utxos[id]);
    }
    release(utxoIdsToEnable) {
        // assigns new array without any utxoIdsToEnable
        this.inUse = this.inUse.filter((utxoId) => utxoIdsToEnable.indexOf(utxoId) === -1);
        // this.updateUtxoBalance();
    }
    updateUtxoBalance() {
        const utxoIds = Object.keys(this.utxos);
        const utxoIdsNotInUse = utxoIds.filter((key) => this.inUse.indexOf(key) === -1);
        this.totalBalance = utxoIds.reduce((prev, cur) => prev + this.utxos[cur].satoshis, 0);
        this.availableBalance = utxoIdsNotInUse.reduce((prev, cur) => prev + this.utxos[cur].satoshis, 0);
    }
    clear() {
        this.utxos = {};
        this.inUse = [];
        this.availableBalance = 0;
        logger_1.logger.log('info', 'UTXO set cleared.');
    }
    /**
     * Naively select UTXOs.
     * @param txAmount Provide the amount that the UTXOs should cover.
     * @throws Error message if the UTXOs can't cover the `txAmount`
     */
    selectUtxos(txAmount) {
        const utxos = [];
        const utxoIds = [];
        let totalVal = 0;
        for (const [utxoId, utxo] of Object.entries(this.utxos)) {
            if (this.inUse.indexOf(utxoId) === -1) {
                utxoIds.push(utxoId);
                utxos.push(utxo);
                totalVal += utxo.satoshis;
            }
            if (totalVal >= txAmount)
                break;
        }
        if (totalVal < txAmount)
            throw new Error(`Transaction compose error. Need: ${txAmount}, UTXO Balance: ${totalVal}`);
        return { utxoIds, utxos };
    }
}
exports.UtxoSet = UtxoSet;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXR4b1NldC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3dhbGxldC9VdHhvU2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLGFBQWE7QUFDYix1REFBdUM7QUFDdkMsNENBQXlDO0FBRXpDLE1BQWEsT0FBTztJQUFwQjtRQUNFLFVBQUssR0FBc0QsRUFBRSxDQUFDO1FBRTlELFVBQUssR0FBYSxFQUFFLENBQUM7UUFFckIsaUJBQVksR0FBRyxDQUFDLENBQUM7UUFFakIscUJBQWdCLEdBQUcsQ0FBQyxDQUFDO1FBTXJCLGdCQUFXLEdBQStCLEVBQUUsQ0FBQztJQWdGL0MsQ0FBQztJQXBGQyxJQUFJLE1BQU07UUFDUixPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUN4QyxDQUFDO0lBSUQ7Ozs7T0FJRztJQUNILEdBQUcsQ0FBQyxLQUFpQixFQUFFLE9BQWU7UUFDcEMsTUFBTSxPQUFPLEdBQWEsRUFBRSxDQUFDO1FBQzdCLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUNyQixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDMUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDcEQsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN6QyxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsYUFBYSxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7Z0JBQ3BELE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQ3JCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSwwQkFBTyxD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QztnQkFDakIsUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUM7YUFDM0I7WUFDRCxJQUFJLFFBQVEsSUFBSSxRQUFRO2dCQUFFLE1BQU07U0FDakM7UUFDRCxJQUFJLFFBQVEsR0FBRyxRQUFRO1lBQ3JCLE1BQU0sSUFBSSxLQUFLLENBQUMsb0NBQW9DLFFBQVEsbUJBQW1CLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDN0YsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQztJQUM1QixDQUFDO0NBQ0Y7QUE3RkQsMEJBNkZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBpIH0gZnJvbSAnY3VzdG9tLXR5cGVzJztcbi8vIEB0cy1pZ25vcmVcbmltcG9ydCBiaXRjb3JlIGZyb20gJ2JpdGNvcmUtbGliLWNhc2gnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcblxuZXhwb3J0IGNsYXNzIFV0eG9TZXQge1xuICB1dHhvczogUmVjb3JkPHN0cmluZywgYml0Y29yZS5UcmFuc2FjdGlvbi5VbnNwZW50T3V0cHV0PiA9IHt9O1xuXG4gIGluVXNlOiBzdHJpbmdbXSA9IFtdO1xuXG4gIHRvdGFsQmFsYW5jZSA9IDA7XG5cbiAgYXZhaWxhYmxlQmFsYW5jZSA9IDA7XG5cbiAgZ2V0IGxlbmd0aCgpOiBudW1iZXIge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLnV0eG9zKS5sZW5ndGg7XG4gIH1cblxuICB1dHhvU3RvcmFnZTogUmVjb3JkPHN0cmluZywgQXBpLlV0eG9bXT4gPSB7fTtcblxuICAvKipcbiAgICogQWRkIFVUWE9zIHRvIFVUWE8gc2V0LlxuICAgKiBAcGFyYW0gdXR4b3MgQXJyYXkgb2YgVVRYT3MgZnJvbSBrYXNwYSBBUEkuXG4gICAqIEBwYXJhbSBhZGRyZXNzIEFkZHJlc3Mgb2YgVVRYTyBvd25lci5cbiAgICovXG4gIGFkZCh1dHhvczogQXBpLlV0eG9bXSwgYWRkcmVzczogc3RyaW5nKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IHV0eG9JZHM6IHN0cmluZ1tdID0gW107XG4gICAgdXR4b3MuZm9yRWFjaCgodXR4bykgPT4ge1xuICAgICAgY29uc3QgdXR4b0lkID0gdXR4by50cmFuc2FjdGlvbklkICsgdXR4by5pbmRleC50b1N0cmluZygpO1xuICAgICAgY29uc3QgdXR4b0luVXNlID0gdGhpcy5pblVzZS5pbmRleE9mKHV0eG9JZCkgIT09IC0xO1xuICAgICAgY29uc3QgYWxyZWFkeUhhdmVJdCA9IHRoaXMudXR4b3NbdXR4b0lkXTtcbiAgICAgIGlmICghdXR4b0luVXNlICYmICFhbHJlYWR5SGF2ZUl0ICYmIHV0eG8uaXNTcGVuZGFibGUpIHtcbiAgICAgICAgdXR4b0lkcy5wdXNoKHV0eG9JZCk7XG4gICAgICAgIHRoaXMudXR4b3NbdXR4b0lkXSA9IG5ldyBiaXRjb3JlLlRyYW5zYWN0aW9uLlVuc3BlbnRPdXRwdXQoe1xuICAgICAgICAgIHR4aWQ6IHV0eG8udHJhbnNhY3Rpb25JZCxcbiAgICAgICAgICBhZGRyZXNzLFxuICAgICAgICAgIHZvdXQ6IHV0eG8uaW5kZXgsXG4gICAgICAgICAgc2NyaXB0UHViS2V5OiB1dHhvLnNjcmlwdFB1YktleSxcbiAgICAgICAgICBzYXRvc2hpczogdXR4by52YWx1ZSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgaWYgKHV0eG9JZHMubGVuZ3RoKSB7XG4gICAgICBsb2dnZXIubG9nKCdpbmZvJywgYEFkZGVkICR7dXR4b0lkcy5sZW5ndGh9IFVUWE9zIHRvIFV0eG9TZXQuYCk7XG4gICAgICAvLyB0aGlzLnVwZGF0ZVV0eG9CYWxhbmNlKCk7XG4gICAgfVxuICAgIHJldHVybiB1dHhvSWRzO1xuICB9XG5cbiAgcmVtb3ZlKHV0eG9JZHM6IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgdGhpcy5yZWxlYXNlKHV0eG9JZHMpO1xuICAgIHV0eG9JZHMuZm9yRWFjaCgoaWQpID0+IGRlbGV0ZSB0aGlzLnV0eG9zW2lkXSk7XG4gIH1cblxuICByZWxlYXNlKHV0eG9JZHNUb0VuYWJsZTogc3RyaW5nW10pOiB2b2lkIHtcbiAgICAvLyBhc3NpZ25zIG5ldyBhcnJheSB3aXRob3V0IGFueSB1dHhvSWRzVG9FbmFibGVcbiAgICB0aGlzLmluVXNlID0gdGhpcy5pblVzZS5maWx0ZXIoKHV0eG9JZCkgPT4gdXR4b0lkc1RvRW5hYmxlLmluZGV4T2YodXR4b0lkKSA9PT0gLTEpO1xuICAgIC8vIHRoaXMudXBkYXRlVXR4b0JhbGFuY2UoKTtcbiAgfVxuXG4gIHVwZGF0ZVV0eG9CYWxhbmNlKCk6IHZvaWQge1xuICAgIGNvbnN0IHV0eG9JZHMgPSBPYmplY3Qua2V5cyh0aGlzLnV0eG9zKTtcbiAgICBjb25zdCB1dHhvSWRzTm90SW5Vc2UgPSB1dHhvSWRzLmZpbHRlcigoa2V5KSA9PiB0aGlzLmluVXNlLmluZGV4T2Yoa2V5KSA9PT0gLTEpO1xuICAgIHRoaXMudG90YWxCYWxhbmNlID0gdXR4b0lkcy5yZWR1Y2UoKHByZXYsIGN1cikgPT4gcHJldiArIHRoaXMudXR4b3NbY3VyXS5zYXRvc2hpcywgMCk7XG4gICAgdGhpcy5hdmFpbGFibGVCYWxhbmNlID0gdXR4b0lkc05vdEluVXNlLnJlZHVjZShcbiAgICAgIChwcmV2LCBjdXIpID0+IHByZXYgKyB0aGlzLnV0eG9zW2N1cl0uc2F0b3NoaXMsXG4gICAgICAwXG4gICAgKTtcbiAgfVxuXG4gIGNsZWFyKCk6IHZvaWQge1xuICAgIHRoaXMudXR4b3MgPSB7fTtcbiAgICB0aGlzLmluVXNlID0gW107XG4gICAgdGhpcy5hdmFpbGFibGVCYWxhbmNlID0gMDtcbiAgICBsb2dnZXIubG9nKCdpbmZvJywgJ1VUWE8gc2V0IGNsZWFyZWQuJyk7XG4gIH1cblxuICAvKipcbiAgICogTmFpdmVseSBzZWxlY3QgVVRYT3MuXG4gICAqIEBwYXJhbSB0eEFtb3VudCBQcm92aWRlIHRoZSBhbW91bnQgdGhhdCB0aGUgVVRYT3Mgc2hvdWxkIGNvdmVyLlxuICAgKiBAdGhyb3dzIEVycm9yIG1lc3NhZ2UgaWYgdGhlIFVUWE9zIGNhbid0IGNvdmVyIHRoZSBgdHhBbW91bnRgXG4gICAqL1xuICBzZWxlY3RVdHhvcyh0eEFtb3VudDogbnVtYmVyKTogeyB1dHhvSWRzOiBzdHJpbmdbXTsgdXR4b3M6IGJpdGNvcmUuVHJhbnNhY3Rpb24uVW5zcGVudE91dHB1dFtdIH0ge1xuICAgIGNvbnN0IHV0eG9zOiBiaXRjb3JlLlRyYW5zYWN0aW9uLlVuc3BlbnRPdXRwdXRbXSA9IFtdO1xuICAgIGNvbnN0IHV0eG9JZHM6IHN0cmluZ1tdID0gW107XG4gICAgbGV0IHRvdGFsVmFsID0gMDtcbiAgICBmb3IgKGNvbnN0IFt1dHhvSWQsIHV0eG9dIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMudXR4b3MpKSB7XG4gICAgICBpZiAodGhpcy5pblVzZS5pbmRleE9mKHV0eG9JZCkgPT09IC0xKSB7XG4gICAgICAgIHV0eG9JZHMucHVzaCh1dHhvSWQpO1xuICAgICAgICB1dHhvcy5wdXNoKHV0eG8pO1xuICAgICAgICB0b3RhbFZhbCArPSB1dHhvLnNhdG9zaGlzO1xuICAgICAgfVxuICAgICAgaWYgKHRvdGFsVmFsID49IHR4QW1vdW50KSBicmVhaztcbiAgICB9XG4gICAgaWYgKHRvdGFsVmFsIDwgdHhBbW91bnQpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRyYW5zYWN0aW9uIGNvbXBvc2UgZXJyb3IuIE5lZWQ6ICR7dHhBbW91bnR9LCBVVFhPIEJhbGFuY2U6ICR7dG90YWxWYWx9YCk7XG4gICAgcmV0dXJuIHsgdXR4b0lkcywgdXR4b3MgfTtcbiAgfVxufVxuIl19